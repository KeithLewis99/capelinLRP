---
title: "simpleLRP_display"
author: "Keith Lewis"
date: "`r Sys.Date()`"
output:
  flexdashboard::flex_dashboard:
    theme: flatly
bibliography: refs/simpleLRP.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
#Available themes include: default blue, cerulean blue, flatly green, readable white, spacelab blue, united purple, simplex bright red, yeti blue.
library(knitr)
library(plotly)
library(ggplot2)
library(crosstalk)
library(xtable)
library(DT)
#library(tidyverse)
#library(lubridate)
#library(kableExtra)
#library(ezknitr)
#library(here)
source("simpleLRP_dat.R")
source("simpleLRP_calc.R")
#source("simpleLRP_figs.R")
shD <- SharedData$new(df_lag)
```

C-68 {data-navmenu="Background"}
=====

<p style="font-size: 20pt">
This dashboard presents a variety of possible LRPs for 2J3KL capelin.  A LRP is mandated for capelin under Bill C-68 and is due in 2023.  
Copy/paste relevant sections from Res Doc

Make sure to have Sections on environmental covariates (Section 6.) and regime shifts.  Long term environmental conditions and time period of LRP - set the stage here (and talk to Fran)
</p>

SAR {data-navmenu="Background"}
=====
```{r}

knitr::include_graphics("images/Presentation1/SAR_table.PNG")

```


Criteria {data-navmenu="Background"}
=====
1. Feasible -can be operationalized by science advice and appropriate management measures (but in SAR: it should be feasible to monitor indicators and estimate stock status relative to the LRP on time scales and frequencies relevant to its role as the trigger for a rebuilding plan) capable of being done or carried out.  
2. Reliable - can be interpreted as acceptable consistency, accuracy or precision of estimates (i.e., acceptably low variance or low bias), and robustness to a range of possible uncertainties (assumptions, stock scale, data points, etc). As the “true” values of reference points are unknown, evaluations of the accuracy and precision (or robustness) of estimates can be conducted in simulation tests of systems with known values. Sensitivity analyses can also be conducted to evaluate the influence of model parameters on reference point estimates.   
3. Plausible - refers to whether estimates, assumptions or hypotheses are consistent with empirical data, ecosystem and population dynamics theory. (does the threshold make sense – clearly 0 or Bo would be both be implausible values.)  


The Roadmap {data-navmenu="Background"}
====

PROBABLY REPLACE THIS WITH THE LRP-SAR APPROACH OR EVEN THE TABLE or Figure  

1.	“Simple” approach  
    + SR relationship  (e.g. Iceland)
        -	Have completed preliminary work  
        -	Working on an age disaggregated approach  
    +	B-RECOVER   
        -	Haddock approach: Done – see dashboard  
        - Barents Sea
    + B-min
        -	Multivariate – see snow crab  
        -	Hierarchical - Done preliminary work  
2.	“Complex” approach  
    i.	Single Species  
        a. State space/IPM
        b. Age-structured 
        c. Delayed Difference  
        d. VPA/SCA  
        e. Surplus Production  
    ii.	Ecosystem 
        a. Ecopath/MICE  
        b. Capcod  
    iii.	Others  
        a. MSE approach (Maritimes – Herring)  
        b.	Deep learning – see Krista Baker  
        c.	Ogmap – probabilities of S-R relationship producing a given outcome   (Geoff)

References {- data-navmenu="Background"}
=====
<div id="refs"></div>


Bmsy {- data-navmenu="Proportions"}
=====

<p style="font-size: 20pt">
Done lots of work here on IPM and SPM approaches
Perhaps present two JABBA graphs showing very low and very high Bmsy
Plus Oceana - need rationale why this is not a good approach - extract summary from  Res Doc
</p>

B0 {- data-navmenu="Proportions"}
=====

Column
-------------------------------------

B0 is multipled by 0.4. This is the standard in the Canadian PA but probably not appropriate here.  

```{r eval=T,prompt=T, comment = F}
#df_keep_rows <- keep_rows("N2", 25)
#tab1 <- tabParm(histLRP, df_keep_rows)
datatable(B0, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F, initComplete = JS("
                        function(settings, json) {
                          $(this.api().table().header()).css({
                          'font-size': '20px',
                          });
                        }
                    "))) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = "20px")
```

Column
-------------------------------------

```{r}
par(mar= c(5, 4, 4, 2) + 0.1)

Scatter1(df = df_cap, xaxis = year, yaxis = biomass_med, colour = rankB, 
         c1 = "Rank: ", c2 = "Year: ", c3 = "Biomass: ", 
         xlab = "Year", ylab = "Capelin biomass (ktonnes)",
         filename = "figs/2-cond-rank-year.pdf", save = "no")

Scatter1(df = df_cap, xaxis = year, yaxis = abundance_med, colour = NULL, 
         c1 = "Rank: ", c2 = "Year: ", c3 = "Abundance: ", 
         xlab = "Year", ylab = "Capelin abundance (billions)",
         filename = "figs/2-cond-rank-year.pdf", save = "no")
```


# Bmsy proxies Fx%SPR
<p style="font-size: 20pt">
THE PROBLEM IS THE SRR (SEE NEXT PAGE). WE CAN GET Fx%SPR but we can't get the SRR so we can't do LRPs.  See next page!
</p>


SRR {data-navmenu="X Rmax"}
=====


<!-- Column -->
  <!-- ------------------------------------- -->
  <!-- BH, Bmsy = -->
  <!-- ```{r} -->
  <!-- plot(sr$biomass_tm2, sr$R, xlim=xlmts, ylim=ylmts, col="white", ylab="Recruits", xlab = "Biomass (ktonnes)") -->
  <!-- polygon(c(x, rev(x)), c(LCI,rev(UCI)), col = "gray80", border=NA) -->
  <!-- points(R~biomass, data = sr, pch =19, col=rgb(0,0,0,1/2)) -->
  <!-- lines(pBH~x, lwd=2) -->
  <!-- abline(v = BmsyBH)  # from standard for Bmsy = 118 -->
  
Column
-------------------------------------
Ricker Bmsy = `r BmsyRkr`
```{r}
plot(sr$biomass_tm2, sr$R, xlim=xlmts_r, ylim=ylmts_r, col="white", ylab="Recruits", xlab = "Biomass (ktonnes)")
polygon(c(xr, rev(xr)), c(LCI_r,rev(UCI_r)), col = "gray80", border=NA)
points(R~biomass_tm2, data = sr, pch =19, col=rgb(0,0,0,1/2))
lines(pR~xr, lwd=2)
abline(v = 0.4*(log(a_r)/b_r)*(0.5-0.07*log(a_r)))  # from standard for Bmsy = 261
```


Iceland {data-navmenu="X Rmax"}
=====

Column
-------------------------------------

All
```{r}
plot(sr$biomass_tm2, sr$R, pch=16, col='steelblue')
plot(segmented.fit, add=T)
```

Post-collapse
```{r}
plot(sr[9:37,]$biomass_tm2, sr[9:37,]$R, pch=16, col='steelblue')
plot(segmented.fit_post, add=T)
```


Bloss {data-navmenu="Historical"}
=====

Column
-------------------------------------

<p style="font-size: 20pt">
Bloss is the lowest observed biomass

</p>

```{r tab2, eval=T,prompt=T, comment = F}
#df_keep_rows <- keep_rows("N2", 25)
#tab1 <- tabParm(histLRP, df_keep_rows)
datatable(Bmin, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F, initComplete = JS("
                        function(settings, json) {
                          $(this.api().table().header()).css({
                          'font-size': '20px',
                          });
                        }
                    "))) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = "20px")
```

Column
-------------------------------------

```{r fig-3}
par(mar= c(5, 4, 4, 2) + 0.1)

Scatter1(df = df_cap, xaxis = year, yaxis = biomass_med, colour = rankB, 
         c1 = "Rank: ", c2 = "Year: ", c3 = "Biomass: ", 
         xlab = "Year", ylab = "Capelin biomass (ktonnes)",
         filename = "figs/2-cond-rank-year.pdf", save = "no")

Scatter1(df = df_cap, xaxis = year, yaxis = abundance_med, colour = NULL, 
         c1 = "Rank: ", c2 = "Year: ", c3 = "Abundance: ", 
         xlab = "Year", ylab = "Capelin abundance (billions)",
         filename = "figs/2-cond-rank-year.pdf", save = "no")
```


Brecover {data-navmenu="Historical"}
=====

<p style="font-size: 20pt">
Brecover is the lowest observed biomass which produced recruitment that lead to stock recovery - we don't have this for capelin
</p>


Bmin {data-navmenu="Historical"}
=====
<p style="font-size: 20pt">
Bmin is the lowest observed biomass from which a recovery to average has been observed or other minimum biomass that produced “good” recruitment
</p>

Column {.tabset}
-------------------------------------
  
### All data: anomalies

Horizontal line is 90th percentile (add others)

```{r fig-8}
Bar1(df = sr, 
     xaxis = year, yaxis = anomaly, 
     c2 = "Biomass[t-2]: ", c3 = "Anomaly: ", 
     xlab = "Year", ylab = "Recruitment anomolies", 
     hline = h90, filename = "figs/3-Biomass_all-year-anomaly.pdf", save = "no")
```

### All data: stock-recruit

black = 90th percentile, red-dashed = 50th, black-dashed = 50th w/o 2010, purple = 40th

```{r fig-9}
Scatter2(df = sr, xaxis = biomass_tm2, yaxis = R, 
         c2 = "Biomass[t-2]: ", c3 = "Recruitment: ", 
         xlab = "Index[t-2] (ktonnes)", ylab = "Recruitment[t] (ktonnes)", 
         vline1 = v90, vline2 = v50, vline3 = v50_alt3, vline4 = v40_alt4, 
         filename = "figs/6-Biomass_postCollapse-index-recruit.pdf", save = "no")
```

Column {.tabset}
-------------------------------------
  
### Post collapse: anomalies

Horizontal line is 90th percentile

```{r fig-10}
Bar1(df = sr_post, xaxis = year, yaxis = anomaly, c2 = "Biomass[t-2]: ", c3 = "Anomaly: ", xlab = "Year", ylab = "Recruitment anomolies", hline = h90_post, filename = "figs/5-Biomass_postCollapse-year-anomaly.pdf", save = "no")
```

### Post collapse: stock-recruit 

black = 90th percentile, red-dashed = 50th, black-dashed = 50th w/o 2010

```{r fig-11}
Scatter2(df = sr_post, 
         xaxis = biomass_tm2, yaxis = R, 
         c2 = "Biomass[t-2]: ", c3 = "Recruitment[t]: ", 
         xlab = "Index[t-2] (ktonnes)", ylab = "Recruitment[t] (ktonnes)", 
         vline1 = v90_post, vline2 = v50_post, vline3 = v50_post_alt,
         filename = "figs/6-Biomass_postCollapse-index-recruit.pdf", save = "no")
```

# Historical from models
<p style="font-size: 20pt">
Only viable if we get the IPM up and running  
Bloss  
Brecover  
Bmin  
</p>



# Historical proxy: Bmsy and B0
A historical proxy for BMSY can be estimated as the mean or median value of an indicator over a historical time period when the indicator is high (and assumed recruitment is stable) and catches are high; or the mean or median value of an indicator over a productive period. 

A historical proxy for B0 can be estimated as the mean/median indicator over a historical time period reflecting the beginning of exploitation, or the maximum value of the indicator if the stock has a history of exploitation. 

This reflects the highest time period on record and could be a historical Bo although this doesn't reflect the beginning of exploitation it is the max value of the indicator.

The mean and median abundance (units) and biomass(ktonnes) for teh pre-collapse(<=1991) and three post-collapse periods multiplied by 0.4.  1999-2018 "captures" the post collapse period without the data gaps of the 1990s and has the high point of 2013-2015, 2011-2018 captures the high point without the 2010 issue while 2012-2015 is just the high point.

Arithmetic v geometric means????????

```{r tab1, eval=T,prompt=T, comment = F}
#df_keep_rows <- keep_rows("N2", 25)
#tab1 <- tabParm(histLRP, df_keep_rows)
datatable(histLRP, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F))
```


# Multivariate

<p style="font-size: 20pt">
Series of Bloss or hierarchical approach - see other dashboard
</p>


# Ecosystem

=====
```{r}

knitr::include_graphics("images/Presentation1/capcod.png")

```


# Length based

# Summary

Table of approaches (rows), time periods (columns), and LRPs (cells) 

or 

Graph of approaches v biomass